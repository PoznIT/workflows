name: Purge Artifacts

on:
  workflow_call:
    inputs:
      repository:
        description: 'Repository to purge artifacts from (e.g., owner/repo)'
        required: true
        type: string
      personal_github_token:
        description: 'Personal GitHub Token with repo scope'
        required: true
        type: string

permissions:
  actions: write
  contents: read

concurrency:
  group: purge-artifacts
  cancel-in-progress: false

jobs:
  delete-artifacts:
    runs-on: ubuntu-latest
    steps:
      - name: List & delete all artifacts
        env:
          GH_REPO: ${{ inputs.repository }}
          GITHUB_TOKEN: ${{ inputs.personal_github_token }}
        run: |
          echo "Fetching artifact IDs..."
          ids=$(gh api repos/$GH_REPO/actions/artifacts --paginate -q '.artifacts[].id')
          if [ -z "$ids" ]; then
            echo "No artifacts to delete."
            exit 0
          fi
          count=0
          for id in $ids; do
            echo "Deleting artifact id=$id"
            gh api -X DELETE repos/$GH_REPO/actions/artifacts/$id >/dev/null
            count=$((count+1))
          done
          echo "Deleted $count artifacts."
