name: deploy
author: lev.pozniakoff
description: deploy
inputs:
    compose_file:
        description: name of the docker-compose file
        required: true
        type: string
    compose_override_file:
        description: name of the docker-compose override file
        required: true
        type: string
        default: docker-compose.override.yml
    deployment_folder:
        description: folder on the server to deploy to
        required: true
        type: string
runs:
  using: composite
  steps:
    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: ${{ inputs.compose_override_file }}, ${{ inputs.compose_file }}
        target: "${{ inputs.deployment_folder }}/${{ github.event.repository.name }}/"
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd ~/.deploy/${{ github.event.repository.name }}
          docker compose -f ${{ inputs.compose_file }} -f ${{ inputs.compose_override_file }} stop
          docker compose -f ${{ inputs.compose_file }} -f ${{ inputs.compose_override_file }} rm -f
          docker rmi $(docker images -a -q)
          docker compose -f ${{ inputs.compose_file }} -f ${{ inputs.compose_override_file }} pull
          docker compose -f ${{ inputs.compose_file }} -f ${{ inputs.compose_override_file }} up -d
